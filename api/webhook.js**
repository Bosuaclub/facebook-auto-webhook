const{GoogleGenerativeAI}=require('@google/generative-ai');const genAI=new GoogleGenerativeAI(process.env.GEMINI_API_KEY||'');const VERIFY_TOKEN=process.env.FACEBOOK_VERIFY_TOKEN||'my_token123';const PAGE_TOKEN=process.env.FACEBOOK_PAGE_ACCESS_TOKEN||'';module.exports=async(req,res)=>{if(req.method==='GET'){const mode=req.query['hub.mode'];const token=req.query['hub.verify_token'];const challenge=req.query['hub.challenge'];if(mode==='subscribe'&&token===VERIFY_TOKEN){return res.status(200).send(challenge);}return res.status(403).send('Forbidden');}if(req.method==='POST'){const body=req.body;if(body.object==='page'){for(const entry of body.entry){for(const event of entry.messaging){if(event.message&&event.message.text){const id=event.sender.id;const msg=event.message.text;const model=genAI.getGenerativeModel({model:'gemini-2.0-flash-exp'});const result=await model.generateContent(`Trả lời ngắn gọn: ${msg}`);const reply=result.response.text();await fetch(`https://graph.facebook.com/v21.0/me/messages?access_token=${PAGE_TOKEN}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({recipient:{id},message:{text:reply}})});}}}return res.status(200).send('OK');}return res.status(404).send('Not Found');}return res.status(405).send('Not Allowed');};
